apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: nixosconfigurations.nio.homystack.com
spec:

  group: nio.homystack.com
  versions:
  - name: v1alpha1
    served: true
    storage: true
    subresources:
      status: {}
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            x-kubernetes-preserve-unknown-fields: true
            type: object
            properties:
              gitRepo:
                type: string
                description: Git repository URL containing NixOS configuration
              ref:
                type: string
                default: "main"
                description: Git reference (branch, tag, or commit hash) to use
              credentialsRef:
                type: object
                properties:
                  name:
                    type: string
                description: Secret with token/SSH key for private repository access
              flake:
                type: string
                description: Flake reference (e.g., .#worker or github:owner/repo#hostname)
              onRemoveFlake:
                type: string
                description: Flake reference to apply when removing (optional)
              configurationSubdir:
                type: string
                description: Subdirectory within the repository where the Nix configuration is located
              fullInstall:
                type: boolean
                default: false
                description: Use nixos-anywhere --kexec for full install (true) or nixos-rebuild switch for update (false)
              machineRef:
                type: object
                properties:
                  name:
                    type: string
                required:
                - name
                description: Reference to Machine resource
              additionalFiles:
                type: array
                items:
                  type: object
                  properties:
                    path:
                      type: string
                      description: Path relative to repository root
                    valueType:
                      type: string
                      enum: [Inline, SecretRef, NixosFacter]
                    inline:
                      type: string
                    secretRef:
                      type: object
                      properties:
                        name:
                          type: string
                      required:
                      - name
                    nixosFacter:
                      type: boolean
                  required:
                  - path
                  - valueType
          status:
            type: object
            x-kubernetes-preserve-unknown-fields: true
            properties:
              fullDiskInstallCompleted:
                type: boolean
                description: Git commit hash that was applied
              appliedCommit:
                type: string
                description: Git commit hash that was applied
              lastAppliedTime:
                type: string
                format: date-time
                description: Timestamp of last successful application
              targetMachine:
                type: string
                description: Name of the Machine resource this configuration is applied to
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                    lastTransitionTime:
                      type: string
                      format: date-time
                    reason:
                      type: string
                    message:
                      type: string
    
    additionalPrinterColumns:
    - name: Git Repo
      type: string
      description: Git repository URL
      jsonPath: .spec.gitRepo
    - name: Flake
      type: string
      description: Flake reference
      jsonPath: .spec.flake
    - name: Target Machine
      type: string
      description: Target machine name
      jsonPath: .spec.machineRef.name
    - name: Full Install
      type: boolean
      description: Whether full installation is required
      jsonPath: .spec.fullInstall
    - name: Applied Commit
      type: string
      description: Applied Git commit
      jsonPath: .status.appliedCommit
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp

  scope: Namespaced
  names:
    plural: nixosconfigurations
    singular: nixosconfiguration
    kind: NixosConfiguration
    shortNames:
    - nixconf
